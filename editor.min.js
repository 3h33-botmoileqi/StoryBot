class Editor extends Story{constructor(){super(),this.editor=!0,this.storyRef=null,this.authors=[],this.loadEditor()}StartStoryEditor(){$("#chat").empty(),this.tapeRequiredFlag=!1,this.playStory()}loadStoryEditor(a,b){this.storyRef=a,this.authors=b.authors,this.loadStory(b),this.editor&&this.loadEditor()}loadEditor(){this.loadAuthors(),this.loadMessages(),this.loadCharacters()}saveStory(a=null){db.collection("stories").doc(id).get().then(b=>{b.ref.update({name:editor.name,config:editor.config,characters:editor.characters,conversation:editor.conversation.map(a=>Object.assign({},a))}),localStorage.lastStory=b.id,null!=a&&a()}).catch(a=>{console.log("Error updating document "+editor.storyRef,a)})}authorDOMElement(a,b){var c=$(`
			<li class="list-group-item d-flex align-items-center author">
				<div class="flex-grow-1 text">${a}</div>
				<button class="btn btn-secondary authorDelete"><i class="fas fa-times"></i></button>
			</li>`);return $(c).find(".authorDelete").click(function(){editor.DeleteAuthor(b)}),c}loadAuthors(){$("#authorsList").empty();for(var a of this.authors)db.collection("users").doc(a).get().then(a=>{$("#authorsList").append(this.authorDOMElement(a.data().email,a.id))})}validateEmail(a){var b=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return b.test((a+"").toLowerCase())}AddAuthor(a){this.validateEmail(a)?db.collection("users").where("email","==",a).get().then(b=>{if(!!b.empty)alert("Utilisateur introuvable");else if(1==b.docs.length){var c=b.docs[0];if(-1==this.authors.findIndex(a=>a.id===c.id)){this.authors.push(c.id);let b=this.authorItemDom(a,c.id);$("#authorsList").append(b),this.storyRef&&db.collection("stories").doc(this.storyRef).update({authors:this.authors})}else alert("Cette personne est d\xE9j\xE0 un auteur de la story")}}):alert("email invalide")}DeleteAuthor(a){if(firebase.auth().currentUser.uid!=a){let b=this.authors.findIndex(b=>b===a);this.authors.splice(b,1),$(`.author:nth-child(${b+1})`).remove(),db.collection("stories").doc(this.storyRef).update({authors:this.authors})}else alert("Vous ne pouvez pas vous supprimer l'acc\xE8s a votre propre story.")}loadCharacters(){var a=this;$(".characterList").each(function(b,c){$(c).empty(),$.each(a.characters,function(b){$(c).is("#mainCharacterList")?$(c).append(a.characterItemDom(b)):$(c).append(`<option value="${b}">${b}</option>`)})})}characterItemDom(a){let b=$(`<li id="character-${a}" class="list-group-item d-flex align-items-center">
				<img class="avatar" src="${this.characters[a].avatar}"/>
				<div class="flex-grow-1 text">${a}</div>
				<div class="btn-group tools">
					<button class="btn btn-secondary characterEdit"><i class="fas fa-user-edit"></i></button>
					<button class="btn btn-secondary characterDelete"><i class="fas fa-times"></i></button>
				</div>
			</li>`);return $(b).find(".characterEdit").click(function(){editor.LoadSelectedCharacter(a)}),$(b).find(".characterDelete").click(function(){editor.DeleteCharacterEditor(a)}),b}characterFormSubmit(){let a=document.forms.characterForm,b=a.isNew.value,c=a.characterName.value,d=a.name.value,e=a.avatar.value?a.avatar.value:"https://cdn.iconscout.com/icon/free/png-256/avatar-380-456332.png",f=a.video.value?a.video.value:"",g=$(quillCharDesc.root.innerHTML).html()?$(quillCharDesc.root.innerHTML).html():"",h={avatar:e,video:f,description:g,defaultSide:a.defaultSide.value};"true"===b?this.insertCharacterEditor(h,d):this.editCharacterEditor(h,d,c),$(".characterFormContainer").hide(),$(".characterListContainer").show()}insertCharacterEditor(a,b){this.characters[b]=a,this.loadCharacters()}editCharacterEditor(a,b,c){b!==c&&this.DeleteCharacter(c),this.characters[b]=a,$(".characterList").each(function(a,d){$(d).is("#mainCharacterList")?$(d).find(`li#character-${c}`).replaceWith(editor.characterItemDom(b)):$(d).find(`option[value="${c}"]`).replaceWith(`<option value="${b}">${b}</option>`)}),$(".messagesGroup-header").each(function(){$(this).find("h6").text()==c&&($(this).find("h6").text(b),$(this).find("img").attr("src",editor.characters[b].avatar))})}DeleteCharacterEditor(a){for(var b=0;b<this.conversation.length;b++)this.conversation[b].character==a&&(this.DeleteMessageEditor(b),b--);this.DeleteCharacter(a),$(".characterList").each(function(b,c){$(c).is("#mainCharacterList")?$(c).find(`li#character-${a}`).remove():$(c).find(`option[value="${a}"]`).remove()})}LoadSelectedCharacter(a,b=!1){$(".page").hide(),$(".characterFormContainer").show();let c=document.forms.characterForm;c.characterName.value=a,c.isNew.value=b;let d=this.characters[a];c.name.value="",c.avatar.value="",c.video.value="",quillCharDesc.root.innerHTML="",c.defaultSide.value="",b||(c.name.value=a,c.avatar.value=d.avatar,c.video.value=d.video?d.video:"",quillCharDesc.root.innerHTML=d.description,c.defaultSide.value=d.defaultSide)}loadMessages(){$("#messageList").empty();for(var a=0;a<this.conversation.length;a++){let b=this.messageItemDom(this.conversation[a],a);$("#messageList").append(b)}let b=$(`<li class="list-group-item">
				<form id="quickMessageForm" name="quickMessageForm" class="form-inline" onsubmit="editor.quickMessageFormSubmit();return false;">
					<select class="form-control characterList" name="character" required></select>
					<input type="text" id="quickText" name="text" hidden>
					<div id="editableQuickText" class="flex-grow-1 text" contenteditable="true" oninput="quickText.value = this.innerHTML;" style="outline: -webkit-focus-ring-color auto 5px;"></div>
					<button type="submit" class="btn btn-dark"><i class="fas fa-plus"></i></button>
				</form>
			</li>`);$("#messageList").append(b),this.MessagelistScrollDown()}MessagelistScrollDown(){$("#messageList").animate({width:"ease-out",scrollTop:$("#messageList").prop("scrollHeight")},750)}GetIdByMessageListElement(a){return $(a).index("#messageList>.messageItem")}GetMessageListElementById(a){return $($(`#messageList>.messageItem`).get(a))}messageItemDom(a,b){let c=$(`<li class="list-group-item d-flex align-items-center messageItem">
				<img class="avatar" src="${this.characters[a.character].avatar}"/>
				<div class="flex-grow-1 text" contenteditable="true">${a.text?a.text:a.payload.type?a.payload.type:""}</div>
				<div class="btn-group tools">
					<button class="btn btn-secondary messageView"><i class="fas fa-eye"></i></button>
					<button class="btn btn-secondary messageEdit"><i class="fas fa-edit"></i></button>
					<button class="btn btn-secondary messageDelete"><i class="fas fa-times"></i></button>
					<button class="btn btn-secondary messageUp"><i class="fas fa-arrow-up"></i></button>
					<button class="btn btn-secondary messageDown"><i class="fas fa-arrow-down"></i></button>
				</div>
			</li>`);return $(c).find(".messageView").click(function(){editor.changeViewMode(!0,editor.GetIdByMessageListElement(c)),changePanel("#chatPanel")}),$(c).find(".messageEdit").click(function(){editor.LoadSelectedMessage(b)}),$(c).find(".messageDelete").click(function(){editor.DeleteMessageEditor(b)}),$(c).find(".messageUp").click(function(){editor.MoveSelectedMessage(editor.GetIdByMessageListElement(c),-1)}),$(c).find(".messageDown").click(function(){editor.MoveSelectedMessage(editor.GetIdByMessageListElement(c),1)}),$(c).find(".text").on("input",function(){editor.onMessageInput(editor.GetIdByMessageListElement(c),$(this).text())}),c}MoveSelectedMessage(a,b){if(0<=a+b&&a+b<this.conversation.length){var c=$(`#messageList>li:nth-child(${a+b+1})`);0<b?c.after($(this.GetMessageListElementById(a)).detach()):c.before($(this.GetMessageListElementById(a)).detach()),this.conversation.splice(a+b,0,this.conversation.splice(a,1)[0])}}quickMessageFormSubmit(){let a=document.forms.quickMessageForm,b=a.text.value,c=new Message(a.character.value,this.characters[a.character.value].defaultSide,b,{},new Date().getTime()/1e3,0,!0,!1);this.insertMessageEditor(this.conversation.length,c),a.text.value="",$("#editableQuickText").text(""),this.MessagelistScrollDown()}messageFormSubmit(){let a=document.forms.messageForm,b=a.isNew.value,c=a.messageId.value,d=new Message(a.character.value,a.side.value,"text"==a.content.value?$(quill.root.innerHTML).html():"","media"==a.content.value?{type:a["payload-type"].value,url:a["payload-url"].value}:{},new Date($("#datetimepicker1").datetimepicker("viewDate")).getTime()/1e3,1e3*a.delay.value,a.tapeFlag.checked,a.adsFlag.value);""!==CodeMirrorAnimations.getValue()&&d.AddAnimations(CodeMirrorAnimations.getValue()),"true"===b?this.insertMessageEditor(c,d):this.editMessageEditor(c,d),$(".messageFormContainer").hide(),$(".messageListContainer").show(),this.MessagelistScrollDown()}insertMessageEditor(a,b){$("#messageList>li").last().before(this.messageItemDom(b,a)),this.conversation.splice(a,0,b),saveStory()}editMessageEditor(a,b){this.conversation.splice(a,1,b),this.GetMessageListElementById(a).replaceWith(this.messageItemDom(b,a))}DeleteMessageEditor(a){this.conversation.splice(a,1),this.GetMessageListElementById(a).remove()}LoadSelectedMessage(a,b=!1){$(".messageListContainer").hide(),$(".messageFormContainer").show(),CodeMirrorAnimations.refresh();let c=document.forms.messageForm;if(c.messageId.value=a,c.isNew.value=b,c.character.value="",c.content.value="text",$("#textPayload").show(),$("#mediaPayload").hide(),c["payload-type"].value="",c["payload-url"].value="",quill.root.innerHTML="",$("#datetimepicker1").datetimepicker("date",new Date),c.delay.value=0,c.tapeFlag.checked=!0,c.adsFlag.checked=!1,!b){let b=this.conversation[a];c.character.value=b.character,c.side.value=b.side,""===b.text?($("#textPayload").hide(),$("#mediaPayload").show(),c.content.value="media",c["payload-type"].value=b.payload.type,c["payload-url"].value=b.payload.url):(c.content.value="text",quill.root.innerHTML=b.text),$("#datetimepicker1").datetimepicker("date",moment(1e3*b.timestamp)),c.delay.value=b.delay/1e3,$("#delayOutput").text(c.delay.value+" sec"),c.tapeFlag.checked=b.tapeFlag,c.adsFlag.checked=b.ads,b.animations&&CodeMirrorAnimations.setValue(b.animations?JSON.stringify(b.animations,null,2):"")}}configFormSubmit(){let a=document.forms.configForm;this.name=a.storyName.value,this.config.isPublished=a.isPublish.checked,this.config.displaycharacterName=a.displaycharacterName.checked,this.config.displaycharacterAvatar=a.displaycharacterAvatar.checked,this.config.displayMessageDate=a.displayMessageDate.checked,this.config.adsEachMessage=!0==a.adsFlag.value?a.adsEachMessages.value:0}loadConfig(){let a=document.forms.configForm;a.storyName.value=this.name,a.isPublish.checked=this.config.isPublished,a.displaycharacterName.checked=this.config.displaycharacterName,a.displaycharacterAvatar.checked=this.config.displaycharacterAvatar,a.displayMessageDate.checked=this.config.displayMessageDate,0<this.config.adsEachMessage?($("#adsConfig").show(),a.adsFlag.checked=!0,a.adsEachMessages.value=this.config.adsEachMessage):$("#adsConfig").hide()}changeViewMode(a,b=-1){this.resumeId=b,!1===a?($("#viewMode").prop("checked",!1),this.editor=!0,this.tapeRequiredFlag&&(this.tapeRequiredFlag=!1,$("#tapeLogo").hide())):!0===a?($("#viewMode").prop("checked",!0),this.editor=!1):console.error("mode unknow"),this.StartStoryEditor()}}
